generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER     // 일반 회원
  ADMIN    // 관리자
  TEACHER  // 인증된 보육교사/특수교사
  LAWYER   // 법률 자문 변호사
}

enum PostCategory {
  FREE         // 자유 게시판
  ANONYMOUS    // 익명 고민
  INFO         // 정보 공유
  KNOWHOW      // 노하우
  LEGAL_QNA    // 법률 Q&A
}

model User {
  id         String   @id @default(cuid())
  email      String   @unique
  password   String?  // OAuth 사용자는 비밀번호 없음
  nickname   String
  role       UserRole @default(USER)
  isVerified Boolean  @default(false)
  
  // 프로필
  profileImage String?  // 프로필 이미지 URL
  
  // 활동 기록
  lastLoginAt DateTime?  // 마지막 로그인 시간
  
  // OAuth2 준비
  provider   String?  @default("local") // "local", "google", "github"
  providerId String?  // OAuth Provider의 고유 ID
  
  posts            Post[]
  comments         Comment[]         @relation("CommentAuthor")
  commentMentions  Comment[]         @relation("CommentMentions")
  likes            Like[]
  refreshTokens    RefreshToken[]
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([provider, providerId])
  @@index([email])
  @@map("users")
}

model Post {
  id          String       @id @default(cuid())
  title       String
  content     String       @db.Text
  category    PostCategory @default(FREE)
  isAnonymous Boolean      @default(false)
  ipHash      String?      // 익명 게시글용 IP 해시
  
  // 통계
  viewCount    Int         @default(0)
  likeCount    Int         @default(0)
  commentCount Int         @default(0)
  
  authorId    String?
  author      User?        @relation(fields: [authorId], references: [id], onDelete: SetNull)
  
  comments    Comment[]
  likes       Like[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([authorId])
  @@index([category])
  @@index([createdAt])
  @@index([viewCount])
  @@index([likeCount])
  @@map("posts")
}

model Comment {
  id        String   @id @default(cuid())
  content   String   @db.Text
  
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  authorId  String
  author    User     @relation("CommentAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  
  // 1 Depth 대댓글 지원
  parentCommentId String?
  parentComment   Comment?  @relation("CommentReplies", fields: [parentCommentId], references: [id], onDelete: Cascade)
  replies         Comment[] @relation("CommentReplies")
  
  // 멘션 기능 (@유저명)
  mentionedUserId String?
  mentionedUser   User?     @relation("CommentMentions", fields: [mentionedUserId], references: [id], onDelete: SetNull)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([postId])
  @@index([authorId])
  @@index([parentCommentId])
  @@index([mentionedUserId])
  @@map("comments")
}

model Like {
  id        String   @id @default(cuid())
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@unique([userId, postId]) // 중복 좋아요 방지
  @@index([userId])
  @@index([postId])
  @@map("likes")
}

model RefreshToken {
  id         String    @id @default(cuid())
  tokenHash  String    @unique
  userId     String
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt  DateTime
  createdAt  DateTime  @default(now())
  revokedAt  DateTime?
  
  // 보안 로그 (선택)
  userAgent  String?
  ipAddress  String?
  
  @@index([userId])
  @@index([tokenHash])
  @@map("refresh_tokens")
}
